<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>debug</title>

    <script type="text/javascript" src="DataStorage.js"></script>

    <script type="text/javascript">
        window.addEventListener('load', main, false);

        class Ingredient {
            constructor() {

            }
        }
        class Recipe {
            constructor() {

            }
        }
        class Meal {
            constructor() {

            }
        }

        async function main() {
            //  Define an instance of `DataStorage`
            window.data = new DataStorage('mealplan', [Ingredient, Recipe, Meal]);

            //  Define a local data cache for demonstration
            let local = 'some data';

            //  Compute hash digest of local data
            console.log('computing hash digest of local data');
            let hash = await data._hash(local);

            //  Output the result of the hash digest
            console.log('hash digest:', hash);

            //  Encrypt the local data string with a given password
            console.log('encrypting local data with password \'password\'');
            let cipher = await DataStorage.encrypt(local, 'password');

            //  Output the result of the encryption
            console.log('encrypted cipher:', cipher);

            //  Decrypt the result back to the original string
            console.log('decrypting cipher');
            let plaintext = await DataStorage.decrypt(cipher, 'password');

            //  Output the result of the decryption
            console.log('decrypted plaintext:', plaintext);

            //  Save local data to disk with key 'demo'
            let key = 'demo';
            let newHash = await DataStorage.write(key, local);

            //  Output the result of the write operation
            console.log('local storage data hash:', newHash);

            //  Read local data from disk
            let dataStr = await DataStorage.read(key);

            //  Output the data read from disk
            console.log('data read from local storage:', dataStr);

            //  Issue XMLHttpRequest for server data file
            let dataFile = await DataStorage.xhrGet('data/demo.json', [{header: 'If-Modified-Since', value: '0'}]);

            //  Output the data fetched from the server file
            console.log('data fetched from server:', dataFile);

            //  POST data to server via XMLHttpRequest
            let time = new Date();
            let response = await DataStorage.xhrPost({[time.toUTCString()]: 'OMG more data'}, 'add.php');

            //  Output the server response to POST request
            console.log('server response:', response);

            //  Write the `_lastSync` property to local storage
            data._lastSync = time.getTime();

            //  Get the `_lastSync` property from local storage
            let lastSync = data._lastSync;

            //  Output the last-sync value as read from local storage
            console.log('last-sync value from local storage:', lastSync);
        }

        /** Demonstration of JavaScript `async` and `await` declarations
         *     The `async` keyword causes a function to return an implicit `Promise`
         *     The `await` keyword causes execution to pause until a Promise returned by the `await`ed function resolves
         *
         * @param str
         * @param algo
         * @returns {Promise<string>}
         */
        async function hash(str = 'some data', algo = 'SHA-256') {
            // console.debug(`Compute hash digest of ${typeof str === 'string' ? `string (length ${str.length})` : `${typeof str}`} using ${alg} algorithm\nvalue: ${str}`);

            //  SubtleCrypto.digest() returns a Promise, so this function needs only to return that promise
            let buf = new TextEncoder('utf-8').encode(str);

            let buff = await window.crypto.subtle.digest(algo, buf);
            let view = new Uint8Array(buff);
            return view.reduce((prev, curr) => {return prev.concat(curr.toString(16).padStart(2, '0'))}, '');
        }
    </script>
</head>
<body>

</body>
</html>